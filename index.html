<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>漿料配比與含水率計算系統</title>
    <style>
        body {
            font-family: Calibri, "Microsoft JhengHei", sans-serif;
            background-color: #f8f9fa;
            padding: 30px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h2 { border-left: 5px solid #007bff; padding-left: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f2f2f2; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        select, input { 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            font-family: Calibri, "Microsoft JhengHei";
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-add { background: #28a745; color: white; margin-bottom: 15px; }
        .btn-del { background: #dc3545; color: white; padding: 5px 10px; }
        .summary-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 25px;
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
        }
        .result-val { font-weight: bold; color: #0056b3; font-size: 1.1em; }
        .highlight { color: #d9534f; font-size: 1.3em; }
    </style>
</head>
<body>

<div class="container">
    <h2>漿料配比計算系統</h2>
    
    <button class="btn btn-add" onclick="addRow()">+ 新增原料</button>

    <table id="formulaTable">
        <thead>
            <tr>
                <th>原料選擇</th>
                <th>固含量 (%)</th>
                <th>添加量 (g)</th>
                <th>含水物重量 (g)</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="recipeBody">
            </tbody>
    </table>

    <div class="summary-box">
        <div>
            <p>目前總重量: <span id="totalWeight" class="result-val">0.0000</span> g</p>
            <p>目前總固重: <span id="totalSolid" class="result-val">0.0000</span> g</p>
            <p>目前含水量: <span id="totalWaterPercent" class="result-val">0.00</span> %</p>
            <p>目前固含量: <span id="currentSolidPercent" class="result-val">0.00</span> %</p>
        </div>
        <div>
            <label><strong>期望目標固含量 (%)：</strong></label>
            <input type="number" id="targetPercent" value="50" step="0.1" oninput="calculateAll()"><br><br>
            <p><strong>需補足之 RO 水重量：</strong></p>
            <p class="highlight"><span id="neededRO">0.0000</span> g</p>
        </div>
    </div>
</div>

<script>
    // 1. 原材料資料庫
    const db = {
        "N58-30K": 99.67,
        "Super P": 99.29,
        "BD_C23": 2.37,
        "SWCNT": 0.85,
        "RO水": 0.00,
        "SBR": 45.65
    };

    // 2. 新增一行
    function addRow() {
        const tbody = document.getElementById('recipeBody');
        const row = document.createElement('tr');
        
        let options = Object.keys(db).map(name => `<option value="${name}">${name}</option>`).join('');
        
        row.innerHTML = `
            <td>
                <select class="mat-select" onchange="updateRow(this)">
                    ${options}
                </select>
            </td>
            <td class="mat-solid">${db["N58-30K"]}%</td>
            <td><input type="number" class="mat-weight" value="0" step="0.0001" oninput="calculateAll()"></td>
            <td class="mat-water-w">0.0000</td>
            <td><button class="btn btn-del" onclick="this.parentElement.parentElement.remove(); calculateAll();">刪除</button></td>
        `;
        tbody.appendChild(row);
        calculateAll();
    }

    // 3. 當選擇原料時，更新該行的固含量顯示
    function updateRow(selectEl) {
        const row = selectEl.parentElement.parentElement;
        const solid = db[selectEl.value];
        row.querySelector('.mat-solid').innerText = solid + "%";
        calculateAll();
    }

    // 4. 核心計算邏輯
    function calculateAll() {
        let totalWeight = 0;
        let totalSolidWeight = 0;
        
        const rows = document.querySelectorAll('#recipeBody tr');
        
        rows.forEach(row => {
            const name = row.querySelector('.mat-select').value;
            const weight = parseFloat(row.querySelector('.mat-weight').value) || 0;
            const solidRate = db[name] / 100;
            
            const solidWeight = weight * solidRate;
            const waterWeight = weight - solidWeight;
            
            // 更新該行含水物重量 (重量 - 固體重量)
            row.querySelector('.mat-water-w').innerText = waterWeight.toFixed(4);
            
            totalWeight += weight;
            totalSolidWeight += solidWeight;
        });

        // 計算目前百分比
        const currentSolidP = totalWeight > 0 ? (totalSolidWeight / totalWeight) * 100 : 0;
        const currentWaterP = 100 - currentSolidP;

        // 反推目標加水量
        const targetP = parseFloat(document.getElementById('targetPercent').value) / 100;
        let neededRO = 0;
        if (targetP > 0 && targetP < (totalSolidWeight / totalWeight || 1)) {
            // 公式：總固重 / 目標比例 = 應有總重
            neededRO = (totalSolidWeight / targetP) - totalWeight;
        }

        // 顯示結果
        document.getElementById('totalWeight').innerText = totalWeight.toFixed(4);
        document.getElementById('totalSolid').innerText = totalSolidWeight.toFixed(4);
        document.getElementById('totalWaterPercent').innerText = currentWaterP.toFixed(2);
        document.getElementById('currentSolidPercent').innerText = currentSolidP.toFixed(2);
        document.getElementById('neededRO').innerText = neededRO > 0 ? neededRO.toFixed(4) : "0.0000 (已超標)";
    }

    // 初始增加一行
    addRow();
</script>

</body>
</html>
